name: Backup Neon DB to Seohost

on:
  schedule:
    - cron: "0 2 * * 0"
  workflow_dispatch:

jobs:
  backup-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # âœ… FIX: We explicitly install lftp here because ubuntu-latest doesn't have it
      - name: Install LFTP
        run: sudo apt-get update && sudo apt-get install -y lftp

      # ðŸ³ DOCKER STEP: Dumps DB without needing local tools
      - name: Create Backup with Docker
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FILENAME="moodbox-backup-${TIMESTAMP}.sql.gz"
          
          # 1. Run Docker container to dump the data
          # 2. Pipe it to gzip running on the host machine
          # This is cleaner than mounting volumes
          docker run --rm \
            postgres:17-alpine \
            pg_dump "$POSTGRES_URL" --no-owner --no-privileges --clean --if-exists \
            | gzip > "$FILENAME"
            
          echo "BACKUP_FILE=$FILENAME" >> $GITHUB_ENV
          echo "âœ… Backup created: $FILENAME"

      # ðŸ“¤ UPLOAD STEP
      - name: Upload via FTPS
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          REMOTE_DIR: /domains/moodbox.pl/db_backups/
        run: |
          # We attempt to upload securely first
          lftp -c "
            set ftp:ssl-auth TLS
            set ftp:ssl-force true
            set ftp:ssl-protect-data true
            # TRY REMOVING THIS LINE BELOW to check security
            set ssl:verify-certificate no
            open -u '$FTP_USER','$FTP_PASS' '$FTP_HOST';
            mkdir -p -f '$REMOTE_DIR';
            put -O '$REMOTE_DIR' '${{ env.BACKUP_FILE }}';
            bye
          "
