name: Backup Neon DB to Seohost

on:
  schedule:
    # Runs every Sunday at 02:00 UTC
    - cron: "0 2 * * 0"
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  backup-and-upload:
    runs-on: ubuntu-latest

    steps:
      # Step 1 â€“ Checkout repo (helps with relative paths and logs)
      - name: Checkout
        uses: actions/checkout@v4

      # Step 2 â€“ Detect Neon DB server version
      - name: Detect Neon PostgreSQL version
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          set -euo pipefail
          echo "ðŸ” Checking Neon database version..."
          sudo apt-get update -qq
          sudo apt-get install -y -qq postgresql-client lsb-release > /dev/null
          VERSION_STR=$(psql "$POSTGRES_URL" -tAc "SHOW server_version;")
          PG_MAJOR_VERSION=$(echo "$VERSION_STR" | cut -d. -f1)
          echo "ðŸ§ª Neon server version: $VERSION_STR"
          echo "PG_MAJOR_VERSION=$PG_MAJOR_VERSION" >> $GITHUB_ENV

      # Step 3 â€“ Install matching PostgreSQL client + lftp
      - name: Install PostgreSQL client & lftp
        run: |
          set -euo pipefail
          echo "ðŸ“¦ Installing PostgreSQL client v${PG_MAJOR_VERSION}..."
          sudo apt-get update
          sudo apt-get install -y curl gnupg lsb-release
          curl -fsSL https://www.postgresql.org/media/keys/ACCC4CF8.asc |
            sudo gpg --dearmor -o /usr/share/keyrings/postgresql-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/postgresql-keyring.gpg] \
            http://apt.postgresql.org/pub/repos/apt \
            $(lsb_release -cs)-pgdg main" |
            sudo tee /etc/apt/sources.list.d/pgdg.list

          sudo apt-get update
          sudo apt-get install -y "postgresql-client-${PG_MAJOR_VERSION}" lftp

          # Make sure we always use that specific client binary
          echo "/usr/lib/postgresql/${PG_MAJOR_VERSION}/bin" >> $GITHUB_PATH

          echo "âœ… PostgreSQL client ready:"
          pg_dump --version
          psql --version

      # Step 4 â€“ Create and compress DB backup
      - name: Create and compress backup
        env:
          POSTGRES_URL: ${{ secrets.POSTGRES_URL }}
        run: |
          set -euo pipefail
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          FILENAME="moodbox-backup-${TIMESTAMP}.sql.gz"

          echo "ðŸ—ƒ Dumping database with pg_dump..."
          pg_dump "$POSTGRES_URL" \
            --no-owner \
            --no-privileges \
            --clean \
            --if-exists \
            | gzip > "$FILENAME"

          echo "âœ… Backup created: $FILENAME"
          echo "BACKUP_FILE=$FILENAME" >> $GITHUB_ENV

      # Step 5 â€“ Upload backup to Seohost via FTPS
      - name: Upload via FTPS
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          REMOTE_DIR: /domains/moodbox.pl/db_backups/
        run: |
          set -euo pipefail
          echo "ðŸš€ Uploading $BACKUP_FILE to $REMOTE_DIR on $FTP_HOST"

          lftp -c "
            set ftp:ssl-auth TLS
            set ftp:ssl-force true
            set ftp:ssl-protect-data true
            set ssl:verify-certificate no
            open -u '$FTP_USER','$FTP_PASS' '$FTP_HOST';
            mkdir -p -f '$REMOTE_DIR';
            put -O '$REMOTE_DIR' '${{ env.BACKUP_FILE }}';
            bye
          "

          echo "âœ… Upload complete!"
